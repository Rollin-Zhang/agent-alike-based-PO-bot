{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "step_report.v1.schema.json",
  "title": "StepReport v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "step_index",
    "tool_name",
    "side_effect",
    "status",
    "code",
    "started_at",
    "ended_at",
    "duration_ms",
    "result_summary",
    "evidence_items"
  ],
  "properties": {
    "step_index": { "type": "integer", "minimum": 1 },
    "tool_name": { "type": "string", "minLength": 1 },
    "side_effect": { "type": "string" },
    "status": { "type": "string", "enum": ["ok", "failed", "blocked"] },
    "code": { "type": ["string", "null"] },
    "started_at": { "type": "string", "format": "date-time" },
    "ended_at": { "type": "string", "format": "date-time" },
    "duration_ms": { "type": "number", "minimum": 0 },
    "result_summary": { "type": "string" },
    "evidence_items": { "type": "array" },
    "dep_snapshot_ref": {
      "type": ["object", "null"],
      "description": "Phase D: Reference to dependency snapshot (if step blocked due to missing deps)",
      "properties": {
        "path": {
          "type": "string",
          "description": "Path to dep_snapshot.v1.json (relative to logs/)"
        },
        "snapshot_id": {
          "type": "string"
        },
        "missing_dep_codes": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "required": ["path", "snapshot_id", "missing_dep_codes"]
    },
    "attempt_events": {
      "type": "array",
      "description": "Phase D: Step-level attempt events (minimal fields for traceability)",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["as_of", "status", "code", "duration_ms"],
        "properties": {
          "as_of": {
            "type": "string",
            "format": "date-time"
          },
          "status": {
            "type": "string",
            "enum": ["ok", "blocked", "failed"]
          },
          "code": {
            "type": ["string", "null"]
          },
          "duration_ms": {
            "type": "number",
            "minimum": 0
          },
          "note": {
            "type": "string",
            "description": "Optional short note (not free-form log text)"
          }
        }
      }
    }
  }
}
