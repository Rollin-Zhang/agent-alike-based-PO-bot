{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "run_report.v1.schema.json",
  "title": "RunReport v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "run_id",
    "as_of",
    "ticket_id",
    "retry_policy_id",
    "max_attempts",
    "terminal_status",
    "primary_failure_code",
    "started_at",
    "ended_at",
    "duration_ms",
    "step_reports",
    "attempt_events"
  ],
  "properties": {
    "version": { "type": "string", "const": "v1" },
    "run_id": { "type": "string", "format": "uuid" },
    "as_of": { "type": "string", "format": "date-time" },
    "ticket_id": { "type": "string", "minLength": 1 },
    "retry_policy_id": { "type": "string", "minLength": 1 },
    "max_attempts": { "type": "integer", "minimum": 1 },
    "terminal_status": { "type": "string", "enum": ["ok", "failed", "blocked"] },
    "primary_failure_code": { "type": ["string", "null"] },
    "started_at": { "type": "string", "format": "date-time" },
    "ended_at": { "type": "string", "format": "date-time" },
    "duration_ms": { "type": "number", "minimum": 0 },
    "step_reports": {
      "type": "array",
      "items": { "$ref": "step_report.v1.schema.json" }
    },
    "attempt_events": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["at", "type", "step_index", "tool_name", "status", "code", "message"],
        "properties": {
          "at": { "type": "string", "format": "date-time" },
          "type": { "type": "string", "enum": ["RUN_START", "RUN_END", "STEP_START", "STEP_END"] },
          "step_index": { "type": ["integer", "null"], "minimum": 1 },
          "tool_name": { "type": ["string", "null"] },
          "status": { "type": ["string", "null"] },
          "code": { "type": ["string", "null"] },
          "message": { "type": ["string", "null"] }
        }
      }
    },
    "mode_snapshot": {
      "type": "object",
      "additionalProperties": false,
      "required": ["as_of", "env", "cutover", "readiness_summary"],
      "properties": {
        "as_of": { "type": "string", "format": "date-time" },
        "env": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "NO_MCP",
            "enableToolDerivation",
            "toolOnlyMode",
            "enableTicketSchemaValidation"
          ],
          "properties": {
            "NO_MCP": { "type": "boolean" },
            "enableToolDerivation": { "type": "boolean" },
            "toolOnlyMode": { "type": "boolean" },
            "enableTicketSchemaValidation": { "type": "boolean" }
          }
        },
        "cutover": {
          "type": "object",
          "additionalProperties": false,
          "required": ["cutover_until_ms", "env_source", "policy_mode", "metrics", "gate"],
          "properties": {
            "cutover_until_ms": { "type": ["integer", "null"] },
            "env_source": { "type": ["string", "null"] },
            "policy_mode": { "type": "string", "enum": ["pre_cutover", "post_cutover"] },
            "metrics": {
              "type": "object",
              "additionalProperties": false,
              "required": ["counters", "counters_by_source"],
              "properties": {
                "counters": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "additionalProperties": false,
                    "required": ["event_type", "field", "count"],
                    "properties": {
                      "event_type": { "type": "string" },
                      "field": { "type": "string" },
                      "count": { "type": "number", "minimum": 0 }
                    }
                  }
                },
                "counters_by_source": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "additionalProperties": false,
                    "required": ["event_type", "field", "count", "source"],
                    "properties": {
                      "event_type": { "type": "string" },
                      "field": { "type": "string" },
                      "count": { "type": "number", "minimum": 0 },
                      "source": { "type": "string" }
                    }
                  }
                }
              }
            },
            "gate": {
              "type": "object",
              "additionalProperties": false,
              "required": ["ok", "mode", "counts", "reasons"],
              "properties": {
                "ok": { "type": "boolean" },
                "mode": { "type": "string", "enum": ["pre_cutover", "post_cutover"] },
                "counts": {
                  "type": "object",
                  "additionalProperties": false,
                  "required": ["canonical_missing", "cutover_violation", "legacy_read"],
                  "properties": {
                    "canonical_missing": { "type": "number", "minimum": 0 },
                    "cutover_violation": { "type": "number", "minimum": 0 },
                    "legacy_read": { "type": "number", "minimum": 0 }
                  }
                },
                "reasons": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            }
          }
        },
        "readiness_summary": {
          "type": "object",
          "additionalProperties": false,
          "required": ["deps_ready", "missing_dep_codes", "total_missing"],
          "properties": {
            "deps_ready": { "type": "boolean" },
            "missing_dep_codes": {
              "type": "array",
              "items": { "type": "string" }
            },
            "total_missing": { "type": "integer", "minimum": 0 },
            "providers_unavailable": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        }
      }
    }
  }
}
